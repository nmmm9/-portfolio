package com.socialimpact.tracker.controller;

import com.socialimpact.tracker.entity.PositiveNews;
import com.socialimpact.tracker.repository.PositiveNewsRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/api/positive-news")
@RequiredArgsConstructor
@CrossOrigin(origins = "*")
public class PositiveNewsController {

    private final PositiveNewsRepository positiveNewsRepository;

    /**
     * GET /api/positive-news/organization/{orgId}
     * ÌäπÏ†ï Ï°∞ÏßÅÏùò Í∏çÏ†ï Îâ¥Ïä§ Î™©Î°ù (ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò)
     */
    @GetMapping("/organization/{orgId}")
    public ResponseEntity<Page<PositiveNews>> getNewsByOrganization(
            @PathVariable Long orgId,
            @RequestParam(required = false) Integer year,
            @RequestParam(required = false) String category,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {

        Pageable pageable = PageRequest.of(page, size);
        Page<PositiveNews> news;

        if (year != null) {
            news = positiveNewsRepository.findByOrganizationAndYear(orgId, year, pageable);
        } else if (category != null && !category.equals("all")) {
            news = positiveNewsRepository.findByOrganization_IdAndCategoryOrderByPublishedDateDesc(
                    orgId, category, pageable);
        } else {
            news = positiveNewsRepository.findByOrganization_IdOrderByPublishedDateDesc(orgId, pageable);
        }

        log.info("üì∞ Retrieved {} news for organization {}", news.getContent().size(), orgId);
        return ResponseEntity.ok(news);
    }

    /**
     * GET /api/positive-news/organization/{orgId}/stats/by-year
     * Ïó∞ÎèÑÎ≥Ñ Îâ¥Ïä§ Í∞úÏàò ÌÜµÍ≥Ñ
     */
    @GetMapping("/organization/{orgId}/stats/by-year")
    public ResponseEntity<List<Map<String, Object>>> getYearlyStats(@PathVariable Long orgId) {
        List<Map<String, Object>> stats = positiveNewsRepository.countByOrganizationGroupByYear(orgId);
        return ResponseEntity.ok(stats);
    }

    /**
     * GET /api/positive-news/organization/{orgId}/stats/by-category
     * Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Îâ¥Ïä§ Í∞úÏàò ÌÜµÍ≥Ñ
     */
    @GetMapping("/organization/{orgId}/stats/by-category")
    public ResponseEntity<List<Map<String, Object>>> getCategoryStats(@PathVariable Long orgId) {
        List<Map<String, Object>> stats = positiveNewsRepository.countByOrganizationGroupByCategory(orgId);
        return ResponseEntity.ok(stats);
    }

    /**
     * GET /api/positive-news/organization/{orgId}/recent
     * ÏµúÍ∑º Îâ¥Ïä§ 5Í∞ú
     */
    @GetMapping("/organization/{orgId}/recent")
    public ResponseEntity<List<PositiveNews>> getRecentNews(@PathVariable Long orgId) {
        List<PositiveNews> news = positiveNewsRepository.findTop5ByOrganization_IdOrderByPublishedDateDesc(orgId);
        return ResponseEntity.ok(news);
    }

    /**
     * GET /api/positive-news/organization/{orgId}/count
     * Ï†ÑÏ≤¥ Îâ¥Ïä§ Í∞úÏàò
     */
    @GetMapping("/organization/{orgId}/count")
    public ResponseEntity<Map<String, Long>> getTotalCount(@PathVariable Long orgId) {
        long count = positiveNewsRepository.countByOrganization_Id(orgId);
        return ResponseEntity.ok(Map.of("total", count));
    }

    /**
     * GET /api/positive-news/{id}
     * ÌäπÏ†ï Îâ¥Ïä§ Ï°∞Ìöå
     */
    @GetMapping("/{id}")
    public ResponseEntity<PositiveNews> getNewsById(@PathVariable Long id) {
        return positiveNewsRepository.findById(id)
                .map(ResponseEntity::ok)
                .orElse(ResponseEntity.notFound().build());
    }

    /**
     * DELETE /api/positive-news/{id}
     * Îâ¥Ïä§ ÏÇ≠Ï†ú
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteNews(@PathVariable Long id) {
        positiveNewsRepository.deleteById(id);
        return ResponseEntity.noContent().build();
    }
}