package com.socialimpact.tracker.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;
import com.socialimpact.tracker.entity.*;
import com.socialimpact.tracker.entity.KpiReport.ReportStatus;
import com.socialimpact.tracker.repository.*;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

@Service
@RequiredArgsConstructor
@Slf4j
public class DartCollectorService {

    private final WebClient.Builder webClientBuilder;
    public final OrganizationRepository organizationRepository;
    public final ProjectRepository projectRepository;
    public final KpiRepository kpiRepository;
    public final KpiReportRepository kpiReportRepository;
    private final DonationRepository donationRepository;



    @Value("${opendart.api-key}")
    private String dartApiKey;

    @Value("${opendart.base-url}")
    private String dartBaseUrl;

    @Value("${ingest.donation.from-year}")
    private int fromYear;

    @Value("${ingest.donation.to-year}")
    private int toYear;

    @Value("${ingest.parallelism:4}")
    private int parallelism;

    @Getter
    private final AtomicInteger totalCompanies = new AtomicInteger(0);
    @Getter
    private final AtomicInteger processedCompanies = new AtomicInteger(0);
    @Getter
    private final AtomicInteger successCount = new AtomicInteger(0);
    @Getter
    private final AtomicInteger failureCount = new AtomicInteger(0);
    @Getter
    private volatile boolean isCollecting = false;
    @Getter
    private volatile long startTime = 0;

    public List<String> fetchAllCorpCodes() {
        log.info("üì• Fetching all corporation codes from DART...");
        log.info("üîë Using API Key: {}...", dartApiKey.substring(0, 10));

        try {
            WebClient webClient = webClientBuilder.baseUrl(dartBaseUrl).build();

            byte[] zipData = webClient.get()
                    .uri(uriBuilder -> uriBuilder
                            .path("/api/corpCode.xml")
                            .queryParam("crtfc_key", dartApiKey)
                            .build())
                    .retrieve()
                    .bodyToMono(byte[].class)
                    .block();

            if (zipData == null || zipData.length == 0) {
                log.error("‚ùå Received empty response from DART API");
                return new ArrayList<>();
            }

            log.info("üì¶ ZIP file size: {} bytes", zipData.length);

            if (zipData.length < 1000) {
                log.error("‚ùå ZIP file too small ({}bytes), might be an error response", zipData.length);
                log.error("Response: {}", new String(zipData, "UTF-8"));
                return new ArrayList<>();
            }

            String xmlContent = unzipCorpCode(zipData);
            List<String> corpCodes = parseCorpCodesFromXml(xmlContent);
            log.info("‚úÖ Successfully fetched {} corporation codes", corpCodes.size());

            return corpCodes;

        } catch (Exception e) {
            log.error("‚ùå Error fetching corp codes from DART", e);
            return new ArrayList<>();
        }
    }
    private String unzipCorpCode(byte[] zipData) throws Exception {
        log.info("üîì Unzipping... {} bytes", zipData.length);

        try (ZipInputStream zis = new ZipInputStream(new ByteArrayInputStream(zipData))) {
            ZipEntry entry;
            int entryCount = 0;

            while ((entry = zis.getNextEntry()) != null) {
                entryCount++;
                log.info("üìÑ Found entry #{}: {}", entryCount, entry.getName());

                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                byte[] buffer = new byte[1024];
                int len;
                while ((len = zis.read(buffer)) > 0) {
                    baos.write(buffer, 0, len);
                }

                String content = baos.toString("UTF-8");
                log.info("‚úÖ Extracted {} bytes from {}", content.length(), entry.getName());
                return content;
            }

            log.error("‚ùå No entries found in ZIP, entry count: {}", entryCount);
        }

        throw new Exception("No entry found in ZIP file");
    }

    private List<String> parseCorpCodesFromXml(String xml) {
        List<String> corpCodes = new ArrayList<>();

        try {
            XmlMapper xmlMapper = new XmlMapper();
            JsonNode root = xmlMapper.readTree(xml);
            JsonNode list = root.get("list");

            if (list != null && list.isArray()) {
                log.info("üìä Found {} items in array", list.size());

                for (JsonNode item : list) {
                    if (!item.has("corp_code")) continue;

                    String corpCode = item.get("corp_code").asText();
                    String stockCode = item.has("stock_code") ? item.get("stock_code").asText().trim() : "";

                    // ÏÉÅÏû•ÏÇ¨ ÌïÑÌÑ∞ÎßÅ: stock_codeÍ∞Ä ÏûàÍ≥† Ïà´ÏûêÎ°úÎßå Íµ¨ÏÑ±Îêú Í≤ΩÏö∞
                    if (!stockCode.isEmpty() && stockCode.matches("\\d{6}")) {
                        corpCodes.add(corpCode);
                    }
                }

                log.info("‚úÖ Total items: {}, Listed companies: {}", list.size(), corpCodes.size());
            }

        } catch (Exception e) {
            log.error("Error parsing XML", e);
        }

        return corpCodes;
    }
    private Organization saveOrUpdateOrganization(String corpName, String stockCode) {
        return organizationRepository.findAll().stream()
                .filter(o -> o.getName().equals(corpName))
                .findFirst()
                .orElseGet(() -> {
                    Organization org = new Organization();
                    org.setName(corpName);
                    org.setType("ÏÉÅÏû•ÏÇ¨");
                    return organizationRepository.save(org);
                });
    }
    
    public double getProgressPercentage() {
        if (totalCompanies.get() == 0) return 0.0;
        return (processedCompanies.get() * 100.0) / totalCompanies.get();
    }

    public long getEstimatedTimeRemaining() {
        if (!isCollecting || processedCompanies.get() == 0) return 0;

        long elapsed = System.currentTimeMillis() - startTime;
        int remaining = totalCompanies.get() - processedCompanies.get();
        long avgTimePerCompany = elapsed / processedCompanies.get();

        return (avgTimePerCompany * remaining) / 1000;
    }
    /**
     * Ï†ÑÏ≤¥ ÏÉÅÏû•ÏÇ¨ Í∏∞Î∂ÄÍ∏à ÏàòÏßë
     */
    public void collectAllListedCompanies() {
        if (isCollecting) {
            log.warn("‚ö†Ô∏è Ïù¥ÎØ∏ ÏàòÏßë ÏûëÏóÖÏù¥ ÏßÑÌñâ Ï§ëÏûÖÎãàÎã§!");
            return;
        }

        isCollecting = true;
        startTime = System.currentTimeMillis();
        totalCompanies.set(0);
        processedCompanies.set(0);
        successCount.set(0);
        failureCount.set(0);

        try {
            log.info("üöÄ Ï†ÑÏ≤¥ ÏÉÅÏû•ÏÇ¨ Í∏∞Î∂ÄÍ∏à ÏàòÏßë ÏãúÏûë");

            List<String> corpCodes = fetchAllCorpCodes();
            totalCompanies.set(corpCodes.size());

            for (String corpCode : corpCodes) {
                collectDonationData(corpCode);
                Thread.sleep(1000);
            }

            log.info("‚úÖ ÏàòÏßë ÏôÑÎ£å! ÏÑ±Í≥µ: {}, Ïã§Ìå®: {}", successCount.get(), failureCount.get());

        } catch (Exception e) {
            log.error("‚ùå ÏàòÏßë ÏûëÏóÖ Ï§ë Ïò§Î•ò", e);
        } finally {
            isCollecting = false;
        }
    }

    /**
     * ÌäπÏ†ï ÌöåÏÇ¨ Í∏∞Î∂ÄÍ∏à ÏàòÏßë
     */
    @Transactional
    public void collectDonationData(String corpCode) {
        try {
            processedCompanies.incrementAndGet();

            WebClient webClient = webClientBuilder.baseUrl(dartBaseUrl).build();
            ObjectMapper mapper = new ObjectMapper();

            // 1. ÌöåÏÇ¨ Ï†ïÎ≥¥
            String companyJson = webClient.get()
                    .uri(ub -> ub.path("/api/company.json")
                            .queryParam("crtfc_key", dartApiKey)
                            .queryParam("corp_code", corpCode)
                            .build())
                    .retrieve()
                    .bodyToMono(String.class)
                    .block();

            JsonNode companyInfo = mapper.readTree(companyJson);
            if (!"000".equals(companyInfo.path("status").asText())) {
                failureCount.incrementAndGet();
                return;
            }

            String corpName = companyInfo.path("corp_name").asText();
            String stockCode = companyInfo.path("stock_code").asText();

            // 2. Organization ÏûêÎèô ÏÉùÏÑ±
            Organization org = organizationRepository.findAll().stream()
                    .filter(o -> o.getName().equals(corpName))
                    .findFirst()
                    .orElseGet(() -> {
                        Organization newOrg = new Organization();
                        newOrg.setName(corpName);
                        newOrg.setType("ÏÉÅÏû•ÏÇ¨");
                        return organizationRepository.save(newOrg);
                    });

            boolean foundData = false;

            // 3. Îã®ÏùºÌöåÏÇ¨ Ïû¨Î¨¥Ï†úÌëú APIÎ°ú Í∏∞Î∂ÄÍ∏à Ï°∞Ìöå
            for (int year = fromYear; year <= toYear; year++) {
                final int currentYear = year; // ÎûåÎã§Ïö© final Î≥ÄÏàò
                try {
                    String fnlttJson = webClient.get()
                            .uri(ub -> ub.path("/api/fnlttSinglAcnt.json")
                                    .queryParam("crtfc_key", dartApiKey)
                                    .queryParam("corp_code", corpCode)
                                    .queryParam("bsns_year", String.valueOf(currentYear))
                                    .queryParam("reprt_code", "11011") // ÏÇ¨ÏóÖÎ≥¥Í≥†ÏÑú
                                    .build())
                            .retrieve()
                            .bodyToMono(String.class)
                            .block();

                    JsonNode fnlttData = mapper.readTree(fnlttJson);
                    if (!"000".equals(fnlttData.path("status").asText())) {
                        log.trace("  {}ÎÖÑ API ÏÉÅÌÉú: {}", currentYear, fnlttData.path("message").asText());
                        continue;
                    }

                    JsonNode list = fnlttData.path("list");
                    if (!list.isArray() || list.size() == 0) {
                        log.trace("  {}ÎÖÑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå", currentYear);
                        continue;
                    }

                    // 4. "Í∏∞Î∂ÄÍ∏à" Ìï≠Î™© Ï∞æÍ∏∞
                    for (JsonNode item : list) {
                        String accountNm = item.path("account_nm").asText();
                        String accountId = item.path("account_id").asText();

                        // dart_Donations ÎòêÎäî Ìï≠Î™©Î™ÖÏóê "Í∏∞Î∂ÄÍ∏à" Ìè¨Ìï®
                        if (accountId.equals("dart_Donations") || accountNm.contains("Í∏∞Î∂ÄÍ∏à")) {
                            // ÎãπÍ∏∞ Í∏àÏï° Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ Ï†ÑÍ∏∞
                            String amountStr = item.path("thstrm_amount").asText();
                            if (amountStr == null || amountStr.isEmpty() || amountStr.equals("-")) {
                                amountStr = item.path("frmtrm_amount").asText();
                            }
                            if (amountStr == null || amountStr.isEmpty() || amountStr.equals("-")) {
                                amountStr = item.path("bfefrmtrm_amount").asText(); // Ï†ÑÏ†ÑÍ∏∞
                            }

                            if (amountStr != null && !amountStr.isEmpty()) {
                                amountStr = amountStr.replaceAll("[^0-9-]", "");

                                if (!amountStr.isEmpty() && !amountStr.equals("-")) {
                                    BigDecimal amount = new BigDecimal(amountStr);

                                    if (amount.compareTo(BigDecimal.ZERO) > 0) {
                                        Donation donation = donationRepository
                                                .findByOrganization_IdAndYearAndQuarter(org.getId(), currentYear, null)
                                                .orElse(new Donation());

                                        donation.setOrganization(org);
                                        donation.setOrganizationName(corpName);
                                        donation.setStockCode(stockCode);
                                        donation.setYear(currentYear);
                                        donation.setQuarter(null);
                                        donation.setDonationAmount(amount);
                                        donation.setDataSource("DART_API");
                                        donation.setReportType("ÏÇ¨ÏóÖÎ≥¥Í≥†ÏÑú");
                                        donation.setVerificationStatus("ÏûêÎèôÏàòÏßë");

                                        donationRepository.save(donation);
                                        foundData = true;

                                        log.info("  ‚úÖ {} {}ÎÖÑ: {} Ïõê ({})",
                                                corpName, currentYear, String.format("%,d", amount), accountNm);
                                        break;
                                    }
                                }
                            }
                        }
                    }

                    Thread.sleep(200); // API Ï†úÌïú Î∞©ÏßÄ

                } catch (Exception e) {
                    log.trace("  {}ÎÖÑ Ïã§Ìå®", currentYear);
                }
            }

            if (foundData) {
                successCount.incrementAndGet();
            } else {
                failureCount.incrementAndGet();
            }

        } catch (Exception e) {
            failureCount.incrementAndGet();
        }
    }

    private BigDecimal parseXbrlForDonation(byte[] zipData) {
        try (ZipInputStream zis = new ZipInputStream(new ByteArrayInputStream(zipData))) {
            ZipEntry entry;

            while ((entry = zis.getNextEntry()) != null) {
                // Ïû¨Î¨¥Ï†úÌëú XML ÌååÏùºÎßå Ï≤òÎ¶¨
                if (!entry.getName().endsWith(".xml")) continue;

                ByteArrayOutputStream baos = new ByteArrayOutputStream();
                byte[] buffer = new byte[1024];
                int len;
                while ((len = zis.read(buffer)) > 0) {
                    baos.write(buffer, 0, len);
                }

                String xmlContent = baos.toString("UTF-8");

                // Í∏∞Î∂ÄÍ∏à Í¥ÄÎ†® ÌÉúÍ∑∏ Í≤ÄÏÉâ
                // XBRL ÌëúÏ§Ä ÌÉúÍ∑∏: tuple_eng_donatio_expendtur_crt_trm_amount
                if (xmlContent.contains("Í∏∞Î∂ÄÍ∏à") || xmlContent.contains("donatio")) {
                    Document doc = Jsoup.parse(xmlContent, "", org.jsoup.parser.Parser.xmlParser());

                    // Í∏∞Î∂ÄÍ∏à Í∏àÏï° Ï∂îÏ∂ú (Ïó¨Îü¨ Ìå®ÌÑ¥ ÏãúÎèÑ)
                    String[] searchTags = {
                            "tuple_eng_donatio_expendtur_crt_trm_amount", // ÎãπÍ∏∞ Í∏∞Î∂ÄÍ∏à
                            "donatio_expendtur_crt_trm_amount",
                            "donation_amount"
                    };

                    for (String tag : searchTags) {
                        Elements elements = doc.select(tag);
                        if (!elements.isEmpty()) {
                            String amountText = elements.first().text().replaceAll("[^0-9]", "");
                            if (!amountText.isEmpty()) {
                                return new BigDecimal(amountText);
                            }
                        }
                    }

                    // ÌÉúÍ∑∏Î°ú Î™ª Ï∞æÏúºÎ©¥ ÌÖçÏä§Ìä∏ Ìå®ÌÑ¥ Í≤ÄÏÉâ
                    String[] patterns = {"Í∏∞Î∂ÄÍ∏à.*?([0-9,]+)", "donatio.*?([0-9,]+)"};
                    for (String pattern : patterns) {
                        java.util.regex.Pattern p = java.util.regex.Pattern.compile(pattern);
                        java.util.regex.Matcher m = p.matcher(xmlContent);
                        if (m.find()) {
                            String amountText = m.group(1).replaceAll(",", "");
                            return new BigDecimal(amountText);
                        }
                    }
                }
            }
        } catch (Exception e) {
            log.debug("XBRL ÌååÏã± Ï§ë Ïò§Î•ò", e);
        }

        return null;
    }

    // API ÌÖåÏä§Ìä∏Ïö© ÏóîÎìúÌè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä
    @GetMapping("/test-dart")
    public ResponseEntity<Map<String, Object>> testDartConnection() {
        try {
            // 1. corpCodes.xml Îã§Ïö¥Î°úÎìú ÌÖåÏä§Ìä∏
            WebClient webClient = webClientBuilder.baseUrl(dartBaseUrl).build();
            String corpCodesXml = webClient.get()
                    .uri(ub -> ub.path("/api/corpCode.xml")
                            .queryParam("crtfc_key", dartApiKey)
                            .build())
                    .retrieve()
                    .bodyToMono(String.class)
                    .block();

            // 2. ÏÇºÏÑ±Ï†ÑÏûê(005930) ÌÖåÏä§Ìä∏
            String testCorpCode = "00126380"; // ÏÇºÏÑ±Ï†ÑÏûê
            String companyJson = webClient.get()
                    .uri(ub -> ub.path("/api/company.json")
                            .queryParam("crtfc_key", dartApiKey)
                            .queryParam("corp_code", testCorpCode)
                            .build())
                    .retrieve()
                    .bodyToMono(String.class)
                    .block();

            return ResponseEntity.ok(Map.of(
                    "status", "success",
                    "corpCodesAvailable", corpCodesXml != null && !corpCodesXml.isEmpty(),
                    "samsungData", companyJson,
                    "message", "DART API Ïó∞Í≤∞ Ï†ïÏÉÅ"
            ));

        } catch (Exception e) {
            return ResponseEntity.status(500).body(Map.of(
                    "status", "error",
                    "message", e.getMessage()
            ));
        }
    }
    private void saveKpiReport(Organization org, BigDecimal amount, int year) {
        String projectName = org.getName() + " CSR " + year;
        Project project = projectRepository.findAll().stream()
                .filter(p -> p.getName().equals(projectName))
                .findFirst()
                .orElseGet(() -> {
                    Project p = new Project();
                    p.setOrganization(org);
                    p.setName(projectName);
                    p.setCategory("CSR");
                    p.setStartDate(LocalDate.of(year, 1, 1));
                    p.setEndDate(LocalDate.of(year, 12, 31));
                    return projectRepository.save(p);
                });

        Kpi kpi = kpiRepository.findByName("Donation Amount")
                .orElseGet(() -> {
                    Kpi newKpi = new Kpi();
                    newKpi.setName("Donation Amount");
                    newKpi.setUnit("Ïõê");
                    newKpi.setCategory("Finance");
                    return kpiRepository.save(newKpi);
                });

        KpiReport report = new KpiReport();
        report.setProject(project);
        report.setKpi(kpi);
        report.setValue(amount);
        report.setReportDate(LocalDate.of(year, 12, 31));
        report.setStatus(ReportStatus.APPROVED);
        report.setApprovedBy("DART_AUTO");

        kpiReportRepository.save(report);
    }
}
